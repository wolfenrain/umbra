import 'dart:typed_data';

import 'dart:ui';

import 'package:umbra_flutter/umbra_flutter.dart';

/// {@template with_uniforms}
/// A Dart Shader class for the `with_uniforms` shader.
/// {@endtemplate}
class WithUniforms extends UmbraShader {
  WithUniforms._(
    Image texture, { 
    required Vector4 color,
    required double mixValue,
  }) : super(
          _cachedProgram!,
          floatUniforms: [
            color.x,
            color.y,
            color.z,
            color.w,
            mixValue,
          ],
          samplers: [
            texture,
          ],
        );

  /// {@macro with_uniforms}
  static Future<WithUniforms> compile(
    Image texture, { 
    required Vector4 color,
    required double mixValue,
  }) async {
    // Caching the program on the first compile call.
    _cachedProgram ??= await FragmentProgram.compile(
      spirv: ByteData.sublistView(Uint8List.fromList(_binary)).buffer,
    );

    return WithUniforms._(
      texture,
      color: color,
      mixValue: mixValue,
    );
  }

  static FragmentProgram? _cachedProgram;
}

const _binary = <int>[];
